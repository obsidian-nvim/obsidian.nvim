name: Sync Docs to Wiki

on:
  release:
    types: [published]

permissions:
  contents: write   # Needed to push wiki

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    steps:
      # Checkout the main repo (docs source)
      - name: Checkout repo
        uses: actions/checkout@v4

      # Clone wiki separately
      - name: Clone wiki
        run: |
          set -euo pipefail

          # Clone wiki repo
          git clone https://github.com/${GITHUB_REPOSITORY}.wiki.git wiki

          cd wiki

          # Force the correct remote (CI-safe)
          git remote remove origin || true
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.wiki.git

          # Guard: only wiki allowed
          REMOTE=$(git remote get-url origin)
          case "$REMOTE" in
            *".wiki.git") ;;
            *)
              echo "‚ùå Refusing to push to non-wiki remote: $REMOTE"
              exit 1
              ;;
          esac

          # Set CI user
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Sync docs
          rsync -av --delete --exclude '.*' ../docs/ .

          # Commit only if changes exist
          git add -A
          git diff --cached --quiet || git commit -m "Sync docs from main repo"

          # Push changes
          git push origin HEAD:master
